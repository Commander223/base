<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>Title</title>


    <script src="assets/js/jquery/jquery-2.1.1.min.js"></script>
    <script src="assets/js/plugins/lodash.min.js"></script>
    <script src="assets/js/plugins/backbone-min.js"></script>
    <script src="assets/js/plugins/joint.min.js"></script>
</head>
<body style="height: 100%">
<div style="height: 50px;"></div>
<div style="height: 100%">
    <div style="width: 200px; float: right; height: 100%">
        <div ondragstart="startDrag(event)" ondrop="drop(event)">
            <img width="50px" src="assets/elements/avatar-empty.svg" value="master">
        </div>
        <a onclick="addNew()">Add</a>
    </div>
    <div id="builder" style="height: 100%; margin-right: 200px;" ondragover="dragOver(event)" ondrop="drop(event)"></div>
</div>
<script type="text/javascript">

    var i = 0;
    function addNew()
    {

        addRh( "rh 1", "rhId 1", "peer 1", "peerId 1" );

            addRh( "rh 2", "rhId 2", "peer 1", "peerId 1" );




        addRh( "rh 1", "rhId 1", "peer 2", "peerId 2" );

        addRh( "rh 1", "rhId 1", "peer 3", "peerId 3" );

        addRh( "rh 2", "rhId 2", "peer 3", "peerId 3" );

        addRh( "rh 3", "rhId 3", "peer 3", "peerId 3" );

        addRh( "rh 4", "rhId 4", "peer 3", "peerId 3" );

        addRh( "rh 1", "rhId 1", "peer 4", "peerId 4" );

        addRh( "rh 1", "rhId 1", "peer 5", "peerId 5" );
    }


    /**
     * ***********************
     */



    var graph = new joint.dia.Graph;

    var paper = new joint.dia.Paper({
        el: $('#builder'),
        width: '100%',
        height: '100%',
        model: graph,
        gridSize: 1
    });


    /**
     * ***********************
     */


    var GRID_SIZE = 50;
    var GRID_SPACING = 5;

    var PEER_MAP = {};
    var PEER_WIDTH = 120;
    var PEER_SPACE = 20;

    var RH_WIDTH = 100;
    var RH_SPACE = 10;


    function startDrag( event )
    {
        event.dataTransfer.setData( "template", $(event.target).attr('value') );
    }

    function drop( event )
    {
        event.preventDefault();
        var data = event.dataTransfer.getData("template");


        var posX = event.offsetX;
        var posY = event.offsetY;

        var models = graph.findModelsFromPoint({x :posX, y: posY});

        for( var i = 0; i < models.length; i++ )
        {
            if( models[i].attributes.hostId !== undefined )
            {
                var rPos = models[i].attributes.position;
                var gPos = placeRhSimple( models[i].attributes.grid, models[i].attributes.gridSize );

                var devElement = new joint.shapes.tm.devElement({
                    position: { x: rPos.x + gPos.x * GRID_SIZE + GRID_SPACING, y: rPos.y + gPos.y * GRID_SIZE + GRID_SPACING },
                    templateName: data,
                    quotaSize: 'SMALL', // var
                    containerName: "EPTA NAME", // var
                    attrs: {
                        image: { 'xlink:href': 'assets/elements/avatar-empty.svg'}, // var
                        'rect.b-magnet': {fill: "#CC00FF"}, // var
                        title: {text: data}
                    },
                    rh: {
                        model: models[i].id,
                        x: gPos.x,
                        y: gPos.y
                    }
                });

                graph.addCell(devElement);
                models[i].embed(devElement);
            }
        }
    }

    function dragOver( event )
    {
        event.preventDefault();

//        g.point(event.offsetX, event.offsetY)
    }

    function addPeer(name, id)
    {
        if( PEER_MAP[id] !== undefined )
            return PEER_MAP[id].id;

        var pos = calculatePeerPos();

        var rect = new joint.shapes.basic.Rect({
            position: { x: pos * ( PEER_WIDTH + PEER_SPACE ), y: 20 },
            size: { width: PEER_WIDTH, height: PEER_WIDTH * 1 },
            grid: {},
            gridSize: { size: 1 },
            peerId: id,
            attrs: { rect: { fill: '#FFBBFF', style:{'pointer-events':'none'} }, text: { text: name }, 'pointer-events':'none' }
        });

        PEER_MAP[id] = { id : rect.id, position : pos + 1 };

        graph.addCell( rect );

        return PEER_MAP[id].id;
    }

    function addRh( rhName, rhId, peerName, peerId )
    {
        var peerCellId= addPeer( peerName, peerId );

        var peer = graph.getCell( peerCellId );
        var pos = peer.attributes.gridSize.size - 1;
        growPeer( peer, 0, RH_WIDTH );
        peer.attributes.gridSize.size++;

        var parentPos = peer.attributes.position;

        var rect = new joint.shapes.basic.Rect({
            position: { x: parentPos.x + RH_SPACE, y: parentPos.y + pos * ( RH_WIDTH + RH_SPACE ) + RH_SPACE },
            size: { width: RH_WIDTH, height: RH_WIDTH },
            grid: [],
            gridSize: { size: 2 },
            hostId: rhId,
            attrs: { rect: { fill: '#E74C3C', style:{'pointer-events':'none'} }, text: { text: rhName }, 'pointer-events':'none' }
        });

        graph.addCell( rect );
        peer.embed( rect );
    }

    function growPeer( peer, x, y )
    {
        peer.attributes.size.width += x;
        peer.attributes.size.height += y;
    }

    function calculatePeerPos()
    {
        var pos = [];

        for (var key in PEER_MAP) {
            if (PEER_MAP.hasOwnProperty(key)) {
                pos.push( PEER_MAP[key].position );
            }
        }

        if( pos.length == 0 )
            return 0;
        if( pos.length == 1 )
            return 1;

        pos.sort();

        for( var i = 1; i < pos.length; i++ )
        {
            if( pos[i - 1] + 1 !== pos[i] )
            {
                return pos[i - 1] + 1;
            }
        }

        return pos[pos.length - 1];
    }

    function placeRhSimple( array, sizeObj )
    {
        var size = sizeObj.size;
        for( var j = 0; j < size; j++ ) {
            for( var i = 0; i < size; i++ ) {
                if( array[i] === undefined ) {
                    array[i] = new Array();
                    array[i][j] = 1;

                    return {x:i, y:j};
                }

                if( array[i][j] !== 1 ) {
                    array[i][j] = 1;
                    return {x:i, y:j};
                }
            }
        }

        array[size] = new Array();
        array[size][0] = 1;
        size++;
        sizeObj.size = size;

        return { x : size - 1, y : 0 };
    }


    paper.on('cell:pointerdown', function(cellView) {
        cellView.prevPos = cellView.model.get('position');
    });

    paper.on('cell:pointerup', function(cellView) {

        if( cellView.model.get( 'containerName' ) === undefined )
            return;

        var models = graph.findModelsFromPoint({x : cellView._dx, y: cellView._dy});

        for( var i = 0; i < models.length; i++ ) {
            if (models[i].get('hostId') !== undefined) {
                if( cellView.model.get("parent") != models[i].id )
                {
                    var rh = cellView.model.get('rh');
                    var prevParent = graph.getCell(cellView.model.get("parent"));
                    prevParent.unembed(cellView.model);
                    delete prevParent.get('grid')[rh.x][rh.y];

                    var rPos = models[i].get('position');
                    var gPos = placeRhSimple( models[i].get('grid'), models[i].get('gridSize') );

                    cellView.model.set('rh', { model: models[i].id, x: gPos.x, y: gPos.y});
                    cellView.model.set('position', { x: rPos.x + gPos.x * GRID_SIZE + GRID_SPACING, y: rPos.y + gPos.y * GRID_SIZE + GRID_SPACING });

                    models[i].embed(cellView.model);


                    return;
                }
            }
        }

        cellView.model.set('position', cellView.prevPos);
    });

//    graph.on('change:position', function(cell) {
//
//        var parentId = cell.get('parent');
//        if (!parentId) return;
//
//        var parent = graph.getCell(parentId);
//        var parentBbox = parent.getBBox();
//        var cellBbox = cell.getBBox();
//
//        if (parentBbox.containsPoint(cellBbox.origin()) &&
//                parentBbox.containsPoint(cellBbox.topRight()) &&
//                parentBbox.containsPoint(cellBbox.corner()) &&
//                parentBbox.containsPoint(cellBbox.bottomLeft())) {
//
//            // All the four corners of the child are inside
//            // the parent area.
//            return;
//        }
//
//        // Revert the child position.
//        cell.set('position', cell.previous('position'));
//    });








    joint.shapes.tm = {};

    //simple creatiom templates
    joint.shapes.tm.toolElement = joint.shapes.basic.Generic.extend({

        toolMarkup: [
            '<g class="element-tools">',
            '<g class="element-tool-remove">',
            '<circle fill="#F8FBFD" r="8" stroke="#dcdcdc"/>',
            '<polygon transform="scale(1.2) translate(-5, -5)" fill="#292F6C" points="8.4,2.4 7.6,1.6 5,4.3 2.4,1.6 1.6,2.4 4.3,5 1.6,7.6 2.4,8.4 5,5.7 7.6,8.4 8.4,7.6 5.7,5 "/>',
            '<title>Remove</title>',
            '</g>',
            /*'<g class="element-call-menu">',
             '<circle fill="#F8FBFD" r="8" stroke="#dcdcdc"/>',
             '<polygon transform="scale(1.2) translate(-5, -5)" fill="#292F6C" points="8.4,2.4 7.6,1.6 5,4.3 2.4,1.6 1.6,2.4 4.3,5 1.6,7.6 2.4,8.4 5,5.7 7.6,8.4 8.4,7.6 5.7,5 "/>',
             '<title>Menu</title>',
             '</g>',*/
            '</g>'
        ].join(''),

        defaults: joint.util.deepSupplement({
            attrs: {
                text: { 'font-weight': 400, 'font-size': 'small', fill: 'black', 'text-anchor': 'middle', 'ref-x': .5, 'ref-y': .5, 'y-alignment': 'middle' },
                'g.element-call-menu': {'ref-x': 18, 'ref-y': 25}
            },
        }, joint.shapes.basic.Generic.prototype.defaults)

    });

    joint.shapes.tm.devElement = joint.shapes.tm.toolElement.extend({

        markup: [
            '<g class="rotatable">',
            '<g class="scalable">',
            '<rect class="b-border"/>',
            '</g>',
            '<title/>',
            '<image/>',
            '<rect class="b-magnet"/>',
            '<g class="b-container-plus-icon">',
            '<line fill="none" stroke="#FFFFFF" stroke-miterlimit="10" x1="0" y1="4.5" x2="9" y2="4.5"/>',
            '<line fill="none" stroke="#FFFFFF" stroke-miterlimit="10" x1="4.5" y1="0" x2="4.5" y2="9"/>',
            '</g>',
            '</g>'
        ].join(''),

        defaults: joint.util.deepSupplement({
            type: 'tm.devElement',
            size: { width: 40, height: 40 },
            attrs: {
                title: {text: 'Static Tooltip'},
                'rect.b-border': {fill: '#fff', stroke: '#dcdcdc', 'stroke-width': 1, width: 40, height: 40, rx: 50, ry: 50},
                //'rect.b-magnet': {fill: '#04346E', width: 10, height: 10, rx: 50, ry: 50, magnet: true, transform: 'translate(16,28)'},
                'rect.b-magnet': {fill: '#04346E', width: 10, height: 10, rx: 50, ry: 50, transform: 'translate(16,28)'},
                'g.b-container-plus-icon': {'ref-x': 17.5, 'ref-y': 30, ref: 'rect', transform: 'scale(0.8)'},
                image: {'ref-x': 9, 'ref-y': 9, ref: 'rect', width: 25, height: 25},
            }
        }, joint.shapes.tm.toolElement.prototype.defaults)
    });

    //custom view
    joint.shapes.tm.ToolElementView = joint.dia.ElementView.extend({
        initialize: function() {
            joint.dia.ElementView.prototype.initialize.apply(this, arguments);
        },
        render: function () {
            joint.dia.ElementView.prototype.render.apply(this, arguments);
            this.renderTools();
            this.update();
            return this;
        },
        renderTools: function () {
            var toolMarkup = this.model.toolMarkup || this.model.get('toolMarkup');
            if (toolMarkup) {
                var nodes = V(toolMarkup);
                V(this.el).append(nodes);
            }
            return this;
        },
        mouseover: function(evt, x, y) {
        },
        pointerclick: function (evt, x, y) {
            this._dx = x;
            this._dy = y;
            this._action = '';
            var className = evt.target.parentNode.getAttribute('class');
            switch (className) {
                case 'element-tool-remove':
                    var rh = this.model.attributes.rh;
                    delete graph.getCell(rh.model).attributes.grid[rh.x][rh.y];
                    this.model.remove();
                    return;
                    break;
                case 'element-call-menu':
                    console.log(this.model);
                    var elementPos = this.model.get('position');
                    $('.js-dropen-menu').css({
                        'left': (elementPos.x + 70) + 'px',
                        'top': (elementPos.y + 83) + 'px',
                        'display': 'block'
                    });
                    return;
                    break;
                case 'rotatable':
                    console.log(this.model);
//                    vm.currentTemplate = this.model;
                    ngDialog.open({
                        template: 'subutai-app/environment/partials/popups/templateSettings.html',
                        scope: $scope
                    });
                    return;
                    break;
                default:
            }
            joint.dia.CellView.prototype.pointerclick.apply(this, arguments);
        }
    });
    joint.shapes.tm.devElementView = joint.shapes.tm.ToolElementView;

    //recource host object
    joint.shapes.recourceHostHtml = {};
    joint.shapes.recourceHostHtml.Element = joint.shapes.basic.Rect.extend({
        defaults: joint.util.deepSupplement({
            type: 'recourceHostHtml.Element',
            attrs: {
                rect: { stroke: 'none', 'fill-opacity': 0 }
            }
        }, joint.shapes.basic.Rect.prototype.defaults)
    });

    // Create a custom view for that element that displays an HTML div above it.
    // -------------------------------------------------------------------------

    joint.shapes.recourceHostHtml.ElementView = joint.dia.ElementView.extend({

        template: [
            '<div class="b-recource-host">',
            '<div class="b-peer-title"></div>',
            '<div class="b-recource-host__inner">',
            '<div class="b-recouce-host-title"></div>',
            '<div class="b-recource-host__containers">',
            '<div class="b-recource-host-containers">',
            '</div>',
            '</div>',
            '</div>',
            '</div>'
        ].join(''),

        initialize: function() {
            _.bindAll(this, 'updateBox');
            joint.dia.ElementView.prototype.initialize.apply(this, arguments);

            this.$box = $(_.template(this.template)());
            this.$box.find('.delete').on('click', _.bind(this.model.remove, this.model));
            this.model.on('change', this.updateBox, this);
            // Remove the box when the model gets removed from the graph.
            this.model.on('remove', this.removeBox, this);

            this.updateBox();
        },
        render: function() {
            joint.dia.ElementView.prototype.render.apply(this, arguments);
            this.paper.$el.prepend(this.$box);
            this.updateBox();
            return this;
        },
        updateBox: function() {
            // Set the position and dimension of the box so that it covers the JointJS element.
            var bbox = this.model.getBBox();

            this.$box.find('.b-peer-title').text(this.model.get('peerName'));
            this.$box.find('.b-recouce-host-title').text(this.model.get('recourceHostName'));
            this.$box.css({ width: bbox.width, height: bbox.height, left: bbox.x, top: bbox.y, transform: 'rotate(' + (this.model.get('angle') || 0) + 'deg)' });
        },
        removeBox: function(evt) {
            this.$box.remove();
        }
    });

</script>
</body>
</html>
