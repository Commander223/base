<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<blueprint xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0"
           xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0">

  <!-- Allow the use of system properties -->
  <ext:property-placeholder placeholder-prefix="$[" placeholder-suffix="]" />

  <cm:property-placeholder persistent-id="broker" update-strategy="none">
    <cm:default-properties>
      <cm:property name="brokerUrl" value="mqtt+nio+ssl://0.0.0.0:8883?needClientAuth=true&amp;transport.enabledProtocols=TLSv1.1" />
      <cm:property name="isPersistent" value="true" />
      <cm:property name="messageTimeout" value="0" />
    </cm:default-properties>
  </cm:property-placeholder>

  <bean id="broker"
        class="io.subutai.core.broker.impl.BrokerImpl"
        init-method="init" destroy-method="dispose" scope="singleton" activation="eager">
    <argument value="${brokerUrl}" />
    <argument value="${isPersistent}" />
    <argument value="${messageTimeout}" />
    <argument value="${keystore}" />
    <argument value="${keystorePassword}" />
    <argument value="${truststore}" />
    <argument value="${truststorePassword}" />
    <argument value="${caCertificate}" />

  </bean>

  <!-- message interceptors start -->

  <reference-list id="byteMessagePreProcessor"
                  interface="io.subutai.core.broker.api.ByteMessagePreProcessor"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addByteMessagePreProcessor" unbind-method="removeByteMessagePreProcessor" />
  </reference-list>

  <reference-list id="byteMessagePostProcessor"
                  interface="io.subutai.core.broker.api.ByteMessagePostProcessor"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addByteMessagePostProcessor" unbind-method="removeByteMessagePostProcessor" />
  </reference-list>
  <reference-list id="textMessagePreProcessor"
                  interface="io.subutai.core.broker.api.TextMessagePreProcessor"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addTextMessagePreProcessor" unbind-method="removeTextMessagePreProcessor" />
  </reference-list>

  <reference-list id="textMessagePostProcessor"
                  interface="io.subutai.core.broker.api.TextMessagePostProcessor"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addTextMessagePostProcessor" unbind-method="removeTextMessagePostProcessor" />
  </reference-list>

  <!-- message interceptors end -->

  <!-- message listeners start -->

  <reference-list id="byteMessageLstnr"
                  interface="io.subutai.core.broker.api.ByteMessageListener"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addByteMessageListener" unbind-method="removeMessageListener" />
  </reference-list>

  <reference-list id="textMessageLstnr"
                  interface="io.subutai.core.broker.api.TextMessageListener"
                  availability="optional">
    <reference-listener ref="broker"
                        bind-method="addTextMessageListener" unbind-method="removeMessageListener" />
  </reference-list>

  <!-- message listeners end -->

  <service ref="broker" interface="io.subutai.core.broker.api.Broker" />

</blueprint>
