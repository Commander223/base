#!/bin/bash

# ==========================================================================
# Set of functions that process locking functionality with a mix of utility
# functions.
# ==========================================================================

function lock_subutai_system {
  mkdir -p $SUBUTAI_LOCK_PATH
  touch $SUBUTAI_LOCK_PATH/system_lock
}

function unlock_subutai_system {
  rm $SUBUTAI_LOCK_PATH/system_lock
}

function is_system_locked {
  ls $SUBUTAI_LOCK_PATH/system_lock > /dev/null 2>&1
  if [ $? == 0 ]
  then
    echo "true"
  else
    echo "false"
  fi
}

function is_system_all_locked {
  (ls $SUBUTAI_LOCK_PATH/system_lock || ls $SUBUTAI_LOCK_PATH/write/*) \
    > /dev/null 2>&1
  if [ $? == 0 ]
  then
    echo "true"
  else
    echo "false"
  fi
}

function lock_container_write {
  mkdir -p $SUBUTAI_LOCK_PATH/write/
  touch $SUBUTAI_LOCK_PATH/write/$1-$2
}

function lock_container_read {
  mkdir -p $SUBUTAI_LOCK_PATH/write/
  mkdir -p $SUBUTAI_LOCK_PATH/read/
  touch $SUBUTAI_LOCK_PATH/write/$1-$2
  touch $SUBUTAI_LOCK_PATH/read/$1-$2
}

function unlock_container_write {
  removing=`ls $SUBUTAI_LOCK_PATH/write/ | grep -e "\b$1\b"`
  rm $SUBUTAI_LOCK_PATH/write/$removing  > /dev/null 2>&1
}

function unlock_container_read {
  removing=`ls $SUBUTAI_LOCK_PATH/write/ | grep -e "\b$1\b"`
  rm $SUBUTAI_LOCK_PATH/write/$removing > /dev/null 2>&1
  rm $SUBUTAI_LOCK_PATH/read/$removing > /dev/null 2>&1
}

function are_containers_locked_write {
  if [[ -z "$2" ]]
  then
    ls $SUBUTAI_LOCK_PATH/read/ | grep -e "\b$1\b" > /dev/null 2>&1
    if [ $? == 0 ]
    then
      echo "true"
    else
      echo "false"
    fi
  else
    (ls $SUBUTAI_LOCK_PATH/read/ | grep -e "\b$1\b" \
     || ls $SUBUTAI_LOCK_PATH/read/ | grep -e "\b$2\b") \
      > /dev/null 2>&1
    if [ $? == 0 ]
    then
      echo "true"
    else
      echo "false"
    fi
  fi
}

function are_containers_locked_read {
  if [[ -z "$2" ]]
  then
    ls $SUBUTAI_LOCK_PATH/write/ | grep -e "\b$1\b" > /dev/null 2>&1
    if [ $? == 0 ]
    then
      echo "true"
    else
      echo "false"
    fi
  else
    (ls $SUBUTAI_LOCK_PATH/write/ | grep -e "\b$1\b" \
     || ls $SUBUTAI_LOCK_PATH/write/ | grep -e "\b$2\b") \
      > /dev/null 2>&1
    if [ $? == 0 ]
    then
      echo "true"
    else
      echo "false"
    fi
  fi
}

