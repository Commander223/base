#!/bin/bash

function master_destroy {
  echo WARNING: this destroys everything mercilessly
  echo \<Return\> to continue, or Ctrl-C to exit
  read

  if [ -z "`zfs list lxc/master`" ]; then
    echo No zfs dataset \'lxc/master\' found - aborting ...
    exit 1
  fi
  local container="master"
  local package_name=`get_package_name $container`
  local debian_root="$SUBUTAI_TMPDIR/$container"

  msg_info "APT_GET_INVOCATION: $APT_GET_INVOCATION"
  if [ -z "$APT_GET_INVOCATION" -o "$APT_GET_INVOCATION" != "true" ]; then
    msg_info "subutai master_destroy called from command line"
    # Check if the package is installed
    dpkg -s $package_name > /dev/null 2>&1
    if [ $? = 0  ]; then
      apt-get --assume-yes --force-yes purge $package_name
      exit $?
    fi
  else
    msg_info "subutai master_destroy called while removing template via package-manager"
  fi

  zfs release keep lxc/master-opt@template
  zfs destroy -r lxc/master-opt

  zfs release keep lxc-data/master-var@template
  zfs destroy -r lxc-data/master-var

  zfs release keep lxc-data/master-home@template
  zfs destroy -r lxc-data/master-home

  zfs release keep lxc/master@template
  zfs destroy -r lxc/master
  lxc-destroy -n master
  
  # Remove relevant directories under $SUBUTAI_TMPDIR if any
  rm -rf $debian_root
}


function master_destroy_description {
  echo destroys the master template
}


