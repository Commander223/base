#!/bin/bash

. /etc/subutai/funcs

function usage {
  echo -----------------------------------------------------------------------
  echo Usage: Exports the master template as a tsar file
  echo
  echo "	"subutai-master-export
  echo
  echo -----------------------------------------------------------------------
}


# Plan for exporting a template
# -----------------------------------------------------------------------------
# (1) perform sanity checks first
# (2) generate delta images of all filesystems: 
#     'pool/parent-partition@child' -> 'pool/child-partition@template'
# (3) generate the tsar file from git differential, deltas, and package info

# -----------------------------------------------------------------------------
# (1) perform some sanity checks
# -----------------------------------------------------------------------------

tsar_file="$SUBUTAI_TMPDIR/master.tsar"
tsar_root="$SUBUTAI_TMPDIR/master"

if [ -f "$tsar_file" ]; then
  msg_notice "It seems the tsar file has already been generated"
  msg_error "Run rm -rf $tsar_root* and try again"
  exit 1
fi

deltas="$tsar_root/deltas"
mkdir -p $deltas

zfs send "lxc/master@template" > "$deltas/rootfs.delta"
if [ $? -eq 0 ]; then
  size=`ls -lh $deltas/rootfs.delta | awk '{print $5}'`
  msg_ok "Exported $size delta for rootfs"
else
  msg_error "Delta generation for rootfs failed"
fi

zfs send "lxc/master-opt@template" > "$deltas/opt.delta"
if [ $? -eq 0 ]; then
  size=`ls -lh $deltas/opt.delta | awk '{print $5}'`
  msg_ok "Exported $size delta for opt"
else
  msg_error "Delta generation for opt failed"
fi

zfs send "lxc-data/master-var@template" > "$deltas/var.delta"
if [ $? -eq 0 ]; then
  size=`ls -lh $deltas/var.delta | awk '{print $5}'`
  msg_ok "Exported $size delta for var"
else
  msg_error "Delta generation for opt failed"
fi

zfs send "lxc-data/master-home@template" > "$deltas/home.delta"
if [ $? -eq 0 ]; then
  size=`ls -lh $deltas/home.delta | awk '{print $5}'`
  msg_ok "Exported $size delta for home"
else
  msg_error "Delta generation for opt failed"
fi


# -----------------------------------------------------------------------------
# (3) generate the tsar file from git differential, deltas, and package info
# -----------------------------------------------------------------------------

lxc_home=/var/lib/lxc/master
cp $lxc_home/config $tsar_root
cp $lxc_home/fstab  $tsar_root
cp $lxc_home/packages  $tsar_root

pushd . > /dev/null
cd "$SUBUTAI_TMPDIR"
tar -zcf master.tsar master

if [ $? -ne 0 ]; then
  msg_error "Failed to properly generate TSAR file: $tsar_file"
else
  msg_ok "Successfully generated TSAR file: $tsar_file"
fi

popd > /dev/null

