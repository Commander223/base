#!/bin/bash

. /etc/subutai/config
. /etc/subutai/functionz

clone=$1

function usage {
  echo -----------------------------------------------------------------------
  echo Usage: Destroy an existing container clone.
  echo
  echo "        "subutai-clone-destory clone-name
  echo
  echo -----------------------------------------------------------------------
}

if [ "$clone" == "master" ]; then
  msg_error "Use subutai-master-destroy instead of subutai-clone-destroy"
  exit 1
fi

# Destruction Plan:
# -----------------------------------------------------------------------------
# (1) check that clone exists first, and find its parent
# (2) check if the clone has dependent child and abort if so
# (3) release all holds on clone's rootfs snapshots
# (4) destroy all snapshots on clones's rootfs
# (5) lxc-destroy the clone
# (6) release all holds on clone's parent rootfs snapshot for child
# (7) destroy clone's snapshot on parent rootfs
# (8) destroy mounted partitions
# -----------------------------------------------------------------------------

# (1) check that clone exists first
check_exists "$clone" "`usage`"

# if running turn it off
if [ -n "`lxc-ls --running | grep $clone`" ]; then
  lxc-stop -n $clone
fi

# (1) let's get the clone's parent
parent_snap=`zfs get origin "lxc/$clone" | grep $clone | awk '{print $3}'`
parent=`echo $parent_snap | sed -e "s/lxc\///" -e "s/@$clone//"`

# (2) check if the clone has dependent children
function get_children {
  clone=$1
  cmd="zfs list -t snapshot -o name -H | grep lxc/$clone"

  for snap in `zfs list -t snapshot -o name -H \
       | grep lxc/$clone@ | grep -v created | grep -v template`; do
    child=`echo $snap | sed -e "s/.*@//"`
    msg_info "    Found child for $clone: $child"
  done
}

get_children $clone
if [ -n "`get_children "$clone"`" ]; then 
  msg_error "Cannot destroy clone with dependent child containers."
  exit 1
fi

# (3) & (4) release all holds on clone's rootfs snaps and delete snaps
for snap in `zfs list -t snapshot -o name -H | grep $clone@`; do
  for hold in `zfs holds -r $snap | grep $snap | awk '{print $2}'`; do
    zfs release $hold $snap
    msg_info "    - \"$hold\" hold removed from $snap"
  done

  zfs destroy $snap
  msg_info "    - \"$snap\" snapshot destroyed"
done

# (5) lxc-destroy the clone
lxc-destroy -n $clone

# (6) release all holds on clone's parent rootfs snapshot for child
for hold in `zfs holds -r $parent_snap | grep $parent_snap | awk '{print $2}'`;
  do
  zfs release $hold $parent_snap
  msg_info "    - \"$hold\" hold removed from parent's \"$parent_snap\""
done

# (7) destroy clone's snapshot on parent rootfs
zfs destroy $parent_snap
msg_info "    - \"$parent_snap\" snapshot destroyed for \"$clone\""

# (8) destroy mounted partitions 
function remove-mount {
  child="$1"
  parent="$2"
  partition="$3"
  pool="$4"

  child_ds="$pool/$child-$partition"
  parent_ds="$pool/$parent-$partition"

  for snap in `zfs list -t snapshot -o name -H | grep $child_ds@`; do
    for hold in `zfs holds -r $snap | grep $snap | awk '{print $2}'`; do
      zfs release $hold $snap
      msg_info "    - \"$hold\" hold removed from \"$snap\""
    done

    zfs destroy $snap
    msg_info "    - \"$snap\" snapshot destroyed"
  done

  # Need to destroy mount
  zfs destroy $child_ds
  msg_info "    - \"$child_ds\" dataset destroyed"
  zfs release keep $parent_ds@$child
  msg_info "    - \"keep\" hold removed from \"$child_ds@$child\""
  zfs destroy $parent_ds@$child
  msg_info "    - \"$parent_ds@$child\" dataset destroyed"
}

remove-mount $clone $parent opt lxc
remove-mount $clone $parent var lxc-data
remove-mount $clone $parent home lxc-data

msg_ok "Destruction of \"$clone\" completed successfully"

