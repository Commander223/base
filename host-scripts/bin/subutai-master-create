#!/bin/bash

. /etc/subutai/functionz # remove me later
. /etc/subutai/zfs_ops
. /etc/subutai/lxc_ops


# Check for Master Existence
# -----------------------------------------------------------------------------

lxc_assert_no master
zfs_assert_nods "lxc/master"


# Create the container
# -----------------------------------------------------------------------------

lxc-create -n master            \
 -t ubuntu                      \
 -B zfs --                      \
 -u $SUBUTAI_USER               \
 -S $SUBUTAI_AUTH_KEY 

# Add config and app data paths to the config file
config=/var/lib/lxc/master/config
for config_path in `echo "$SUBUTAI_CONFIG_PATH" | sed -e "s/\:/ /g"`; do
  echo subutai.config.path=$config_path >> $config
done

for appdata_path in `echo "$SUBUTAI_APP_DATA_PATH" | sed -e "s/\:/ /g"`; do
  echo subutai.app.data.path=$appdata_path >> $config
done

# Add pre-start hook script entry
echo lxc.hook.pre-start=/etc/subutai/pre-start-hook >> $config

mkdir /var/lib/lxc/master/rootfs/etc/subutai

# files. Then we can take the template snapshot.
#
# (0) Start it up, update, dist-upgrade, shutdown
# (1) Backup rootfs contents and delete contents
# (2) Take created snapshot and hold
# (3) Recover from backup of rootfs
# (4) Delete backup
# (5) Setup git repository in / and control /etc
# (6) Tag template snapshot and hold

# (0)

if [ -n "$SUBUTAI_APT_MIRROR" ]; then
  echo "$SUBUTAI_APT_MIRROR archive.ubuntu.com" >> /var/lib/lxc/master/rootfs/etc/hosts
  echo "$SUBUTAI_APT_MIRROR security.ubuntu.com" >> /var/lib/lxc/master/rootfs/etc/hosts
fi

lxc_wait_net master
lxc-attach -n master -- apt-get update
lxc-attach -n master -- apt-get -y dist-upgrade

if [ -n "$SUBUTAI_PACKAGES" ]; then
  lxc-attach -n master -- \
      apt-get -y install `echo $SUBUTAI_PACKAGES | sed -e "s/,/ /"`
fi

lxc-attach -n master -- apt-get -y autoclean
lxc-attach -n master -- apt-get -y autoremove

rootfs_etc_conf=/var/lib/lxc/master/rootfs/etc/subutai

if [ ! -d "$rootfs_etc_conf" ]; then 
  mkdir -p $rootfs_etc_conf
fi

echo "dpkg -l" | lxc-attach -n master > $rootfs_etc_conf/package-manifest.txt

lxc-stop -n master
lxc-wait -n master -s 'STOPPED'
sleep 2

# (5) setup git repository in / and control /etc
cd /var/lib/lxc/master/rootfs/
git init
git config user.email "$SUBUTAI_EMAIL"
git config user.name  "$SUBUTAI_USER"
echo etc/mtab*      >> .gitignore
echo mtab*          >> .gitignore
echo etc/*.old      >> .gitignore
echo *.old          >> .gitignore
echo etc/blkid.tab  >> .gitignore
echo blkid.tab      >> .gitignore
echo etc/adjtime    >> .gitignore
echo adjtime        >> .gitignore
echo bin            >> .gitignore
echo boot           >> .gitignore
echo dev            >> .gitignore
echo home           >> .gitignore
echo initrd.*       >> .gitignore
echo lib            >> .gitignore
echo lib64          >> .gitignore
echo lost+found     >> .gitignore
echo lxc            >> .gitignore
echo lxc-data       >> .gitignore
echo media          >> .gitignore
echo mnt            >> .gitignore
echo opt            >> .gitignore
echo proc           >> .gitignore
echo root           >> .gitignore
echo run            >> .gitignore
echo sbin           >> .gitignore
echo srv            >> .gitignore
echo sys            >> .gitignore
echo tmp            >> .gitignore
echo usr            >> .gitignore
echo var            >> .gitignore
echo vmlinuz*       >> .gitignore
git add .gitignore
git commit -m 'setting up git for master'
git add -A
git commit -m 'initial master /etc import for master'

# (6)
echo Taking @template snapshot of master\'s rootfs
zfs snapshot lxc/master@template
zfs hold keep lxc/master@template

# Handle all other mountpoints
# -----------------------------------------------------------------------------
# Using the addmount function almost the same operations as we did above on 
# the rootfs are handled: whatever existing data that was found inside the 
# mount point on the rootfs are moved over to the new dataset once created
# snapshots with holds are taken.

addmount master opt lxc
addmount master home lxc-data
addmount master var lxc-data

