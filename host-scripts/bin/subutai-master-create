#!/bin/bash

. /etc/subutai/funcs

# Check for Master Existence
# -----------------------------------------------------------------------------

lxc_assert_no master
zfs_assert_nods "lxc/master"


# Create the container
# -----------------------------------------------------------------------------
# Two modes: import and create

tsar_file=$SUBUTAI_TMPDIR/master.tsar
tsar_dir=$SUBUTAI_TMPDIR/master
config=$tsar_dir/config
fstab=$tsar_dir/fstab
deltas=$tsar_dir/deltas

if [ -f "$tsar_file" ]; then
  msg_info "Using available TSAR file for import: $tsar_file"

  if [ -d "$tsar_dir" ]; then
    rm -rf $tsar_dir
  fi

  pushd . >> /dev/null
  cd $SUBUTAI_TMPDIR
  tar -zxvf $tsar_file
  popd >> /dev/null

  lxc_home=/var/lib/lxc/master
  lxc_rootfs=$lxc_home/rootfs
  mkdir -p $lxc_rootfs
  cp $config $lxc_home
  cp $fstab $lxc_home
  cp $tsar_dir/packages $lxc_home

  zfs recv lxc/master < $deltas/rootfs.delta
  zfs hold keep lxc/master@template
  zfs set mountpoint=$lxc_rootfs lxc/master
  if [ $? -eq 0 ]; then
    size=`ls -lh $deltas/rootfs.delta | awk '{print $5}'`
    msg_ok "Imported $size delta for rootfs"
  else
    msg_error "Delta import for rootfs failed"
  fi

  zfs recv lxc/master-opt < $deltas/opt.delta
  zfs hold keep lxc/master-opt@template
  if [ $? -eq 0 ]; then
    size=`ls -lh $deltas/opt.delta | awk '{print $5}'`
    msg_ok "Imported $size delta for opt"
  else
    msg_error "Delta import for opt failed"
  fi

  zfs recv lxc-data/master-var < $deltas/var.delta
  zfs hold keep lxc-data/master-var@template
  if [ $? -eq 0 ]; then
    size=`ls -lh $deltas/var.delta | awk '{print $5}'`
    msg_ok "Imported $size delta for var"
  else
    msg_error "Delta import for var failed"
  fi
  
  zfs recv lxc-data/master-home < $deltas/home.delta
  zfs hold keep lxc-data/master-home@template
  if [ $? -eq 0 ]; then
    size=`ls -lh $deltas/home.delta | awk '{print $5}'`
    msg_ok "Imported $size delta for home"
  else
    msg_error "Delta generation for opt failed"
  fi

  msg_ok "Master import from TSAR file successful"
  exit 0
fi

lxc-create -n master            \
 -t ubuntu                      \
 -B zfs --                      \
 -u $SUBUTAI_USER               \
 -S $SUBUTAI_AUTH_KEY 

# Add config and app data paths to the config file
config=/var/lib/lxc/master/config
for config_path in `echo "$SUBUTAI_CONFIG_PATH" | sed -e "s/\:/ /g"`; do
  echo subutai.config.path = $config_path >> $config
done

for appdata_path in `echo "$SUBUTAI_APP_DATA_PATH" | sed -e "s/\:/ /g"`; do
  echo subutai.app.data.path = $appdata_path >> $config
done

# Add pre-start hook script entry
echo lxc.hook.pre-start = /etc/subutai/pre_start_hook >> $config
echo subutai.parent = master >> $config
echo subutai.git.branch = master >> $config

mkdir /var/lib/lxc/master/rootfs/etc/subutai

# files. Then we can take the template snapshot.
#
# (0) Start it up, update, dist-upgrade, shutdown
# (1) Backup rootfs contents and delete contents
# (2) Take created snapshot and hold
# (3) Recover from backup of rootfs
# (4) Delete backup
# (5) Setup git repository in / and control /etc
# (6) Tag template snapshot and hold

# (0)

if [ -n "$SUBUTAI_APT_MIRROR" ]; then
  echo "$SUBUTAI_APT_MIRROR archive.ubuntu.com" >> /var/lib/lxc/master/rootfs/etc/hosts
  echo "$SUBUTAI_APT_MIRROR security.ubuntu.com" >> /var/lib/lxc/master/rootfs/etc/hosts
fi

lxc_wait_net master
lxc-attach -n master -- apt-get update
lxc-attach -n master -- apt-get -y dist-upgrade

if [ -n "$SUBUTAI_PACKAGES" ]; then
  lxc-attach -n master -- \
      apt-get -y install `echo $SUBUTAI_PACKAGES | sed -e "s/,/ /"`
fi

lxc-attach -n master -- apt-get -y autoclean
lxc-attach -n master -- apt-get -y autoremove

echo "dpkg -l" | lxc-attach -n master > /var/lib/lxc/master/packages

lxc-stop -n master
lxc-wait -n master -s 'STOPPED'
sleep 2

# (5) setup git repository in / and control /etc
cd /var/lib/lxc/master/rootfs/
git init
git config user.email "$SUBUTAI_EMAIL"
git config user.name  "$SUBUTAI_USER"
echo etc/mtab*      >> .gitignore
echo mtab*          >> .gitignore
echo etc/*.old      >> .gitignore
echo *.old          >> .gitignore
echo etc/blkid.tab  >> .gitignore
echo blkid.tab      >> .gitignore
echo etc/adjtime    >> .gitignore
echo adjtime        >> .gitignore
echo bin            >> .gitignore
echo boot           >> .gitignore
echo dev            >> .gitignore
echo home           >> .gitignore
echo initrd.*       >> .gitignore
echo lib            >> .gitignore
echo lib64          >> .gitignore
echo lost+found     >> .gitignore
echo lxc            >> .gitignore
echo lxc-data       >> .gitignore
echo media          >> .gitignore
echo mnt            >> .gitignore
echo opt            >> .gitignore
echo proc           >> .gitignore
echo root           >> .gitignore
echo run            >> .gitignore
echo sbin           >> .gitignore
echo srv            >> .gitignore
echo sys            >> .gitignore
echo tmp            >> .gitignore
echo usr            >> .gitignore
echo var            >> .gitignore
echo vmlinuz*       >> .gitignore
git add .gitignore
git commit -m 'setting up git for master'
git add -A
git commit -m 'initial master /etc import for master'
uuid=`git log | grep commit | head -n 1 | awk '{print $2}'`
echo subutai.git.uuid = $uuid >> $config

# (6)
echo Taking @template snapshot of master\'s rootfs
zfs snapshot lxc/master@template
zfs hold keep lxc/master@template

# Handle all other mountpoints
# -----------------------------------------------------------------------------
# Using the addmount function almost the same operations as we did above on 
# the rootfs are handled: whatever existing data that was found inside the 
# mount point on the rootfs are moved over to the new dataset once created
# snapshots with holds are taken.

addmount master opt lxc
addmount master home lxc-data
addmount master var lxc-data

